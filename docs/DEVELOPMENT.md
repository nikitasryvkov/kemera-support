# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Python 3.12**, [aiogram 3.x](https://docs.aiogram.dev/) ‚Äî —Ç–µ–ª–µ–≥—Ä–∞–º-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫.
- **Redis** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, FAQ, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è).
- **APScheduler** ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.
- **aiogram-newsletter** ‚Äî –º–æ–¥—É–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏.
- **pytest** ‚Äî —Ç–µ—Å—Ç—ã.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
app/
‚îú‚îÄ‚îÄ __main__.py            # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –ª–æ–≥–≥–µ—Ä, –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ config.py              # dataclass-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (bot + redis)
‚îú‚îÄ‚îÄ logger.py              # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞ (.logs + stdout)
‚îú‚îÄ‚îÄ migrations/            # Redis-–º–∏–≥—Ä–∞—Ü–∏–∏ (—Å–∞–Ω–∏—Ç–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏ —Ç.–ø.)
‚îî‚îÄ‚îÄ bot/
    ‚îú‚îÄ‚îÄ handlers/          # –†–æ—É—Ç–µ—Ä—ã aiogram (private/group/admin/FAQ)
    ‚îú‚îÄ‚îÄ middlewares/       # Redis, –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π, throttle, newsletter
    ‚îú‚îÄ‚îÄ types/             # –î–æ–ø. –º–æ–¥–µ–ª–∏ (–∞–ª—å–±–æ–º—ã –∏ —Ç.–¥.)
    ‚îú‚îÄ‚îÄ utils/             # FAQ, —Ç–µ–∫—Å—Ç—ã, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, Redis-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    ‚îú‚îÄ‚îÄ commands.py        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –≤ Telegram
    ‚îî‚îÄ‚îÄ manager.py         # Manager ‚Äî –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ Bot + FSM –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```

### –ü–æ—Ç–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (private)

1. `RedisMiddleware` –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç/—Å–æ–∑–¥–∞—ë—Ç `UserData`, `SettingsStorage`, `FAQStorage`.
2. `ManagerMiddleware` –∏–Ω–∂–µ–∫—Ç–∏—Ç `Manager` (—É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, state).
3. Handlers (command/message/faq) –∏—Å–ø–æ–ª—å–∑—É—é—Ç `Manager` –¥–ª—è UX.
4. Redis —Ö—Ä–∞–Ω–∏—Ç:
   - `users` hash + –∏–Ω–¥–µ–∫—Å—ã –ø–æ —Ç–µ–º–∞–º (`users_index_*`);
   - `settings` hash (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è/closing);
   - `faq:items` hash + `faq:order` —Å–ø–∏—Å–æ–∫;
   - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è/—Å–ª—É–∂–µ–±–Ω—ã–µ –∫–ª—é—á–∏.

### –ê–Ω—Ç–∏—Å–ø–∞–º –∏ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

- `security.analyze_user_message`: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–º—ë–Ω, username, —Ç–µ–∫—Å—Ç–∞ –Ω–∞ t.me/–æ–±—Ñ—É—Å–∫–∞—Ü–∏—é.
- –ü—Ä–∏ –±–ª–æ–∫–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (`app/bot/handlers/private/message.py`), —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª—è–µ—Ç—Å—è, –≤ –≥—Ä—É–ø–ø—É —É—Ö–æ–¥–∏—Ç –∞–ª–µ—Ä—Ç.

### FAQ

- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis (`FAQStorage`).
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏.
- FAQ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–∏–Ω–ª–∞–π–Ω-–º–µ–Ω—é: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ ¬´–º–∏–≥–∞–Ω–∏—è¬ª), —É–¥–∞–ª–µ–Ω–∏–µ.

### –õ–æ–≥–∏

- `setup_logger()` –ø–∏—à–µ—Ç –≤ `.logs/YYYY-mm-dd_HH-MM-SS.log` + stdout.
- –°—Ç–∞—Ä—Ç–∞–ø-–ª–æ–≥ (`support_bot.startup`) –≤—ã–≤–æ–¥–∏—Ç –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —ç—Ç–∞–ø—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å —ç–º–æ–¥–∑–∏.
- –ê–≤—Ç–æ–±–∞–Ω –ø–∏—à–µ—Ç warning —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–∏—á–∏–Ω–∞–º–∏.
- –î–ª—è –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º `logging.getLogger(__name__)`, —É—Ä–æ–≤–µ–Ω—å INFO/WARNING.

## –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

- **–ö–æ–¥–∏—Ä–æ–≤–∫–∞:** UTF-8, —Ç–µ–∫—Å—Ç–æ–≤–∫–∏ ‚Äî —á–µ—Ä–µ–∑ `TextMessage`.
- **–¢–µ—Å—Ç—ã:** `pytest` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥ –ø—É—à–µ–º).
- **–°—Ç–∞–π–ª:** –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–µ–º—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (black-like, 120 cols).
- **–§–∞–π–ª—ã:** –ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ `apply_patch`, –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã ‚Äî —Ç–æ–ª—å–∫–æ ASCII/UTF-8.
- **–õ–æ–≥–∏:** –ª—é–±—ã–µ –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–∏—à–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ (`extra` –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç `"–∫–ª—é—á=–∑–Ω–∞—á–µ–Ω–∏–µ"`).
- **FSM:** –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –º–µ–Ω—é —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å–º. `Manager.send_message(replace_previous=False)`).

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

1. **–•—Ä–∞–Ω–∏–ª–∏—â–µ**
   - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî –Ω–æ–≤—ã–π Redis Storage (`app/bot/utils/redis`).
   - –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π ‚Äî –¥–æ–±–∞–≤–∏—Ç—å callback –≤ `MIGRATIONS`.
2. **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å**
   - Public UX: –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã (`app/bot/handlers/private`).
   - Group UX: `app/bot/handlers/group`.
   - Admin: –ø–∏—Å–∞—Ç—å –≤ `private/admin_*.py`, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ + FSM.
3. **–ú–µ–Ω—é**
   - –ö–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ `InlineKeyboardBuilder`, `replace_previous=False`.
4. **–¢–µ–∫—Å—Ç—ã**
   - –í—Å–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî –≤ `TextMessage` (`app/bot/utils/texts.py`).
5. **–õ–æ–≥–∏**
   - –ù–∞–∑–≤–∞–Ω–∏—è –ª–æ–≥–≥–µ—Ä–æ–≤: `support_bot.<–º–æ–¥—É–ª—å>`.

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
pip install -r requirements.txt                    # –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
python -m app                                     # –∑–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ
pytest                                            # —Ç–µ—Å—Ç—ã
python scripts/redis_backup.py backup --compress  # –ø–æ–ª–Ω—ã–π –¥–∞–º–ø Redis
python scripts/redis_backup.py restore backups/db.rdb.gz --data-dir ./redis/data  # –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
docker compose up -d --build
```

## FAQ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

- **–ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã?** `.env`, —à–∞–±–ª–æ–Ω ‚Äî `.env.example`.
- **–ù—É–∂–Ω—ã –ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏?** –ï—Å–ª–∏ –º–µ–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É Redis-–¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∫–ª—é—á–∏.
- **–ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏?** –î–∞, –ø—Ä–∞–≤–∫–æ–π `logging.basicConfig`; –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å `level`.
- **–ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å FAQ?** –ß–µ—Ä–µ–∑ –∏–Ω–ª–∞–π–Ω-–º–µ–Ω—é (`/faq` –∏–ª–∏ `üìö FAQ`), –º–µ–¥–∏–∞-–∞–ª—å–±–æ–º—ã –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è.

## –ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ

–í –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –±—É–¥–µ—Ç –ø–∞–Ω–µ–ª—å –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π: –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é / —Å–∫—Ä—ã—Ç—å / —É–¥–∞–ª–∏—Ç—å / –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å (–æ—Ç–∫—Ä—ã—Ç–æ/–∑–∞–∫—Ä—ã—Ç–æ).

panel_message_id —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ UserData; –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ —ç—Ç–æ –ø–æ–ª–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω—è—Ç—å.

–ö–Ω–æ–ø–∫–∏ support_panel:* –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: ForceReply –¥–ª—è –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞, –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–æ—Ç–∫—Ä—ã—Ç–æ/–∑–∞–∫—Ä—ã—Ç–æ), –∞ —Ç–∞–∫–∂–µ –∫–Ω–æ–ø–∫—É ¬´–≤–µ—Ä–Ω—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è¬ª.

–ö–ª—é—á–∏ –∏–¥—É—Ç –≤ TextMessage (support_panel_*), –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ app/bot/handlers/group/panel.py.
